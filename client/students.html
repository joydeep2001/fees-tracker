<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fees List</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"
      integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="style.css" type="text/css" />
  </head>
  <body>
    <!-- Modal For Screenshot display -->
    <div
      class="modal fade p-1 modal-md"
      id="exampleModalLong"
      tabindex="-1"
      role="dialog"
      aria-labelledby="ss-modal"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLongTitle">
              Payment ScreenShot
            </h5>
            <div>
            <button
              type="button"
              value="VERIFIED"
              data-bs-dismiss="modal"
              onclick="verifyPayment(event)"
              class="btn btn-success"
            >
              Verify
            </button>
            <button
              type="button"
              value="REJECTED"
              data-bs-dismiss="modal"
              onclick="verifyPayment(event)"
              class="btn btn-danger"
            >
              Reject
            <!-- </button>
              <span aria-hidden="true">&times;</span>
            </button> -->
          </div>
        </div>
          <div class="modal-body">Loading...</div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            
          </div>
        </div>
      </div>
    </div>
    <!-- Modal for filter -->
    <div
      class="modal fade p-1"
      id="FilterModalLong"
      tabindex="-1"
      role="dialog"
      aria-labelledby="filter-modal"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div  class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="FilterModalLongTitle">Filter</h5>
            <button
              type="button"
              class="close"
              data-bs-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-4 form-check">
                <input
                  class="form-check-input"
                  checked
                  type="checkbox"
                  id="pending"
                />
                <label class="form-check-label" for="pending"> Pending </label>
              </div>
              <div class="col-4 form-check">
                <input
                  class="form-check-input"
                  checked
                  type="checkbox"
                  id="verified"
                />
                <label class="form-check-label" for="verified">
                  Verified
                </label>
              </div>
              <div class="col-4 form-check">
                <input
                  class="form-check-input"
                  checked
                  type="checkbox"
                  id="rejected"
                />
                <label class="form-check-label" for="rejected">
                  Rejected
                </label>
              </div>
            </div>
            <div class="row g-3">
              <div class="col md-6">
                <label for="month" class="form-label">Month</label>
                <input id="month" class="form-control" type="month" />
              </div>
              <div class="col md-6">
                <label for="student-name" class="form-label">Name</label>
                <input id="student-name" class="form-control" type="text" />
              </div>
            </div>
            <div class="row g-3">
              <div class="col md-2">
                <label for="sem" class="form-label">Semester</label>
                <input id="sem" class="form-control" type="number" />
              </div>
              <div class="col md-5">
                <label for="clg" class="form-label">College</label>
                <input id="clg" class="form-control" type="text" />
              </div>
              <div class="col md-5">
                <label for="p-mode" class="form-label">Payment mode</label>
                <input id="p-mode" class="form-control" type="text" />
              </div>
            </div>
            <div class="row g-3">
              <div class="col md-2">
                <label for="mobile" class="form-label">Mobile No.</label>
                <input id="mobile" class="form-control" type="number" />
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button
              onclick="getFilteredData()"
              type="button"
              class="btn btn-success"
            >
              Search
            </button>
          </div>
        </div>
      </div>
    </div>
    <header style="height: 80px;" class="bg-white  sticky-top">
      <button
        id="filter"
        type="button"
        class="btn btn-primary"
        data-bs-toggle="modal"
        data-bs-target="#FilterModalLong"
      >
        Filter
      </button>
    <button
    id="sort"
    type="button"
    onclick="sortByName()"
    class="btn btn-primary"
   
  >
    Sort
  </button>
  </header>
    <table class="table table-striped">
      <thead style="top: 80px;"  class="bg-dark text-light position-sticky">
        <tr>
          <th scope="col">#</th>
          <th scope="col">Name <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-up" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5z"/>
          </svg></th>
          <th scope="col">Semester</th>
          <th scope="col">College</th>
          <th scope="col">Fees of Month</th>
          <th scope="col">Payment Mode</th>
          <th scope="col">Mobile No.</th>
          <th scope="col">Gurdian Mobile No.</th>
          <th scope="col">Payment Date and Time</th>
          <th scope="col">Verification Status</th>
          <th scope="col">ScreenShot</th>
        </tr>
      </thead>
      <tbody >
        <!-- please wait alert -->
        <div
        id="wait-alert"
        class="position-fixed h-100 w-100 top-0 left-0 d-flex justify-content-center align-items-center"
        style="background-color: #000000a5"
      >
        <h2 class="mx-2 text-info">Please wait</h2>

        <div class="spinner-border text-info" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
      </tbody>
    </table>


    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3"
      crossorigin="anonymous"
    ></script>
    <script>
      let cachedData = [];
      let filteredData = [];
      let paymentId = "";
      function showSSinModal(event) {
        paymentId = event.target.id;
        const [targetEl] = cachedData.filter(
          (fee) => fee._id === event.target.id
        );
        const modalBody = document.querySelector(".modal-body");
        modalBody.innerHTML = `<div class="loading"><img style="height: 500px; width: 300px;" src=${targetEl.screenshotURL} height='inherit' width='inherit'></div>`;
      }
      function getFilteredData() {
        const studentName = document.querySelector("#student-name");
        const clg = document.querySelector("#clg");
        const month = document.querySelector("#month");
        const mobile = document.querySelector("#mobile");
        const paymentMode = document.querySelector("#p-mode");
        const sem = document.querySelector("#sem");
        const rejected = document.querySelector("#rejected");
        const verified = document.querySelector("#verified");
        const pending = document.querySelector("#pending");

        function filterTest(value, field) {
          if (field.value.trim() === "") return true;
          return field.value == value;
        }
        function verificationFilter(value, [pending, rejected, verified]) {
          if (value === "PENDING" && !pending.checked) return false;
          if (value === "VERIFIED" && !verified.checked) return false;
          if (value === "REJECTED" && !rejected.checked) return false;
          return true;
        }
        Array.prototype.debug = function () {
          console.log(this);
          return this;
        };
        filteredData = cachedData
          .filter((student) => filterTest(student.name, studentName))
          .debug()
          .filter((student) => filterTest(student.college, clg))
          .debug()
          .filter((student) => filterTest(student.mobile, mobile))
          .debug()
          .filter((student) => filterTest(student.feesMonth, month))
          .debug()
          .filter((student) => filterTest(student.sem, sem))
          .debug()
          .filter((student) => filterTest(student.paymentMode, paymentMode))
          .debug()
          .filter((student) =>
            verificationFilter(student.verificationStatus, [
              pending,
              rejected,
              verified,
            ])
          )
          .debug();
        createTable(filteredData);
        const myModalEl = document.querySelector("#FilterModalLong");
        const modal = bootstrap.Modal.getInstance(myModalEl);
        modal.hide();
      }
      async function verifyPayment(event) {
        const response = await fetch("/api/fees/updateVerificationStatus", {
          method: "POST",
          mode: "cors",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            verificationStatus: event.target.value,
            paymentId: paymentId,
          }),
        });
        if (response.ok && response.status === 200) {
          const data = await response.json();
          console.log(data.id);
          for (let i = 0; i < cachedData.length; i++) {
            if (cachedData[i]._id === paymentId) {
              cachedData[i].verificationStatus = event.target.value;
              break;
            }
          }
          getFilteredData();
        } else {
          alert("please retry");
        }
      }
      function createTable(data) {
        const tbody = document.querySelector("tbody");

        tbody.innerHTML = "";
        const styleClassToPaymentStatus = {
          PENDING: "bg-warning",
          VERIFIED: "bg-success",
          REJECTED: "bg-danger",
        };
        data.forEach((fee, sl) => {
          const row = document.createElement("tr");
          row.innerHTML += `<th scope="row">${sl + 1}</th>`;
          row.innerHTML += `<td>${fee.name}</td>`;
          row.innerHTML += `<td>${fee.sem}</td>`;
          row.innerHTML += `<td>${fee.college}</td>`;
          row.innerHTML += `<td>${fee.feesMonth}</td>`;
          row.innerHTML += `<td>${fee.paymentMode}</td>`;
          row.innerHTML += `<td>${fee.mobile}</td>`;
          row.innerHTML += `<td>${fee.gurdianMobile}</td>`;
          row.innerHTML += `<td>${fee.timestamp}</td>`;

          row.innerHTML += `<td><span class="badge ${
            styleClassToPaymentStatus[fee.verificationStatus]
          } text-light">${fee.verificationStatus}</span></td>`;

          row.innerHTML += `<td><button onclick=showSSinModal(event) id=${fee._id} type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModalLong">Show</button></td>`;
          tbody.appendChild(row);
          //hide the loader
          const waitAlert = document.querySelector("#wait-alert");
          waitAlert.classList.add("d-none");
        });
      }
      async function getStudents() {
        const URL = "/api/fees";
        const TEST_URL = "test_data.json";
        const response = await fetch(URL);
        console.log(response);
        if (response.ok && response.status === 200) {
          const data = await response.json();
          console.log(data);
          cachedData = data.fees;
          filteredData = cachedData;
          createTable(filteredData);
        }
      }
      function sortByName() {
        console.log('sorting')
        filteredData.sort((a, b) => {
          if(a.name.toUpperCase() > b.name.toUpperCase()) {
            return 1;
          }
          return -1;
          
        });
        
        createTable(filteredData);
      }

      //main()
      getStudents();
    </script>
  </body>
</html>
